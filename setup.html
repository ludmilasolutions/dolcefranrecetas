<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema Pasteler√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            max-width: 800px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            margin: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .logo {
            font-size: 2.8rem;
            color: #7b4397;
            margin-bottom: 10px;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.2rem;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            border-left: 5px solid #7b4397;
        }
        
        .card h2 {
            color: #444;
            margin-bottom: 15px;
            font-size: 1.4rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }
        
        input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e1e5eb;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #7b4397;
            box-shadow: 0 0 0 3px rgba(123, 67, 151, 0.2);
        }
        
        .btn {
            background: linear-gradient(to right, #7b4397, #dc2430);
            color: white;
            border: none;
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 7px 20px rgba(123, 67, 151, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .logs {
            background: #1a1a1a;
            color: #f0f0f0;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 14px;
        }
        
        .log-entry {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        
        .success {
            color: #4CAF50;
        }
        
        .error {
            color: #f44336;
        }
        
        .warning {
            color: #FF9800;
        }
        
        .info {
            color: #2196F3;
        }
        
        .status-bar {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .status-ready {
            background: #e8f5e9;
            color: #2e7d32;
            border: 2px solid #4CAF50;
        }
        
        .status-warning {
            background: #fff3e0;
            color: #ef6c00;
            border: 2px solid #FF9800;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }
        
        .steps:before {
            content: '';
            position: absolute;
            top: 20px;
            left: 10%;
            right: 10%;
            height: 3px;
            background: #e0e0e0;
            z-index: 1;
        }
        
        .step {
            text-align: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }
        
        .step-number {
            width: 40px;
            height: 40px;
            background: #e0e0e0;
            color: #666;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 10px;
            font-weight: bold;
            font-size: 18px;
        }
        
        .step.active .step-number {
            background: linear-gradient(to right, #7b4397, #dc2430);
            color: white;
        }
        
        .step.completed .step-number {
            background: #4CAF50;
            color: white;
        }
        
        .step-label {
            font-size: 14px;
            color: #666;
        }
        
        .step.active .step-label {
            color: #7b4397;
            font-weight: 600;
        }
        
        .firebase-config {
            background: #fff8e1;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid #FFB300;
            margin-top: 20px;
        }
        
        .firebase-config h3 {
            color: #FF6F00;
            margin-bottom: 10px;
        }
        
        .firebase-config ol {
            padding-left: 20px;
            margin-bottom: 15px;
        }
        
        .firebase-config li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 25px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .steps {
                flex-direction: column;
                gap: 20px;
            }
            
            .steps:before {
                display: none;
            }
            
            .step {
                display: flex;
                align-items: center;
                gap: 15px;
            }
            
            .step-number {
                margin: 0;
                flex-shrink: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üç∞</div>
            <h1>Sistema de Gesti√≥n para Pasteler√≠a</h1>
            <p class="subtitle">Configuraci√≥n inicial del sistema de recetas, stock, costos y lista de compras</p>
        </div>
        
        <div id="statusBar" class="status-bar status-warning">
            ‚ö†Ô∏è Sistema no configurado. Complete la configuraci√≥n inicial.
        </div>
        
        <div class="steps">
            <div class="step active">
                <div class="step-number">1</div>
                <div class="step-label">Credenciales</div>
            </div>
            <div class="step">
                <div class="step-number">2</div>
                <div class="step-label">Base de Datos</div>
            </div>
            <div class="step">
                <div class="step-number">3</div>
                <div class="step-label">Usuario Admin</div>
            </div>
            <div class="step">
                <div class="step-number">4</div>
                <div class="step-label">Datos de Ejemplo</div>
            </div>
        </div>
        
        <div class="card">
            <h2>Credenciales de Firebase</h2>
            <p>Ingrese las credenciales de su proyecto Firebase. Puede obtenerlas desde Firebase Console ‚Üí Configuraci√≥n del proyecto ‚Üí Configuraci√≥n general ‚Üí Aplicaciones web.</p>
            
            <form id="setupForm">
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" placeholder="AIzaSyBx..." required>
                </div>
                
                <div class="form-group">
                    <label for="authDomain">Auth Domain</label>
                    <input type="text" id="authDomain" placeholder="tu-proyecto.firebaseapp.com" required>
                </div>
                
                <div class="form-group">
                    <label for="projectId">Project ID</label>
                    <input type="text" id="projectId" placeholder="tu-proyecto" required>
                </div>
                
                <div class="form-group">
                    <label for="storageBucket">Storage Bucket</label>
                    <input type="text" id="storageBucket" placeholder="tu-proyecto.appspot.com" required>
                </div>
                
                <div class="form-group">
                    <label for="messagingSenderId">Messaging Sender ID</label>
                    <input type="text" id="messagingSenderId" placeholder="123456789012" required>
                </div>
                
                <div class="form-group">
                    <label for="appId">App ID</label>
                    <input type="text" id="appId" placeholder="1:123456789012:web:abcdef123456" required>
                </div>
                
                <button type="submit" class="btn" id="setupBtn">
                    üëâ Inicializar Base de Datos
                </button>
            </form>
        </div>
        
        <div class="firebase-config">
            <h3>¬øC√≥mo obtener las credenciales de Firebase?</h3>
            <ol>
                <li>Accede a <a href="https://console.firebase.google.com/" target="_blank">Firebase Console</a></li>
                <li>Crea un nuevo proyecto o selecciona uno existente</li>
                <li>En la p√°gina principal del proyecto, haz clic en "Agregar aplicaci√≥n" (√≠cono web)</li>
                <li>Registra tu aplicaci√≥n con un nombre (ej: "Pasteler√≠a App")</li>
                <li>Copia las credenciales que Firebase te proporciona y p√©galas en los campos anteriores</li>
            </ol>
        </div>
        
        <div class="logs" id="logs">
            <div class="log-entry info">üìã Registros de configuraci√≥n aparecer√°n aqu√≠...</div>
        </div>
    </div>

    <script type="module">
        // Importar Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            collection, 
            getDoc, 
            serverTimestamp,
            writeBatch 
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            signOut 
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

        // Elementos del DOM
        const setupForm = document.getElementById('setupForm');
        const setupBtn = document.getElementById('setupBtn');
        const logsDiv = document.getElementById('logs');
        const statusBar = document.getElementById('statusBar');
        const steps = document.querySelectorAll('.step');

        // Variables globales
        let app, db, auth;

        // Verificar si el sistema ya est√° configurado
        async function checkSetup() {
            try {
                // Intentar cargar configuraci√≥n desde localStorage
                const savedConfig = localStorage.getItem('pasteleria_firebase_config');
                
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // Configurar Firebase con credenciales guardadas
                    app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    // Verificar si el setup ya se complet√≥
                    const configDoc = await getDoc(doc(db, 'config', 'app'));
                    
                    if (configDoc.exists() && configDoc.data().setupCompleted) {
                        showStatus('ready', '‚úÖ Sistema ya inicializado. Redirigiendo a la aplicaci√≥n...');
                        
                        // Redirigir a la app despu√©s de 3 segundos
                        setTimeout(() => {
                            window.location.href = 'app.html';
                        }, 3000);
                        
                        setupBtn.disabled = true;
                        setupBtn.textContent = 'Sistema ya configurado';
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.log('No hay configuraci√≥n previa o error:', error.message);
                return false;
            }
        }

        // Funci√≥n para mostrar logs
        function logMessage(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            logEntry.innerHTML = `${getTimestamp()} ${getIcon(type)} ${message}`;
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Actualizar paso activo
            updateSteps(type);
        }

        // Funci√≥n para obtener timestamp
        function getTimestamp() {
            const now = new Date();
            return `[${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}]`;
        }

        // Funci√≥n para obtener icono seg√∫n tipo
        function getIcon(type) {
            switch(type) {
                case 'success': return '‚úÖ';
                case 'error': return '‚ùå';
                case 'warning': return '‚ö†Ô∏è';
                case 'info': return 'üìã';
                default: return 'üìù';
            }
        }

        // Funci√≥n para actualizar pasos
        function updateSteps(type) {
            if (type === 'success') {
                const currentStep = document.querySelector('.step.active');
                if (currentStep) {
                    currentStep.classList.remove('active');
                    currentStep.classList.add('completed');
                    
                    const nextStep = currentStep.nextElementSibling;
                    if (nextStep) {
                        nextStep.classList.add('active');
                    }
                }
            }
        }

        // Funci√≥n para mostrar estado
        function showStatus(type, message) {
            statusBar.className = `status-bar status-${type}`;
            statusBar.innerHTML = type === 'ready' ? '‚úÖ' : '‚ö†Ô∏è';
            statusBar.innerHTML += ` ${message}`;
        }

        // Funci√≥n para inicializar la base de datos
        async function initializeDatabase(config) {
            try {
                logMessage('Inicializando Firebase...', 'info');
                
                // Guardar configuraci√≥n en localStorage
                localStorage.setItem('pasteleria_firebase_config', JSON.stringify(config));
                
                // Inicializar Firebase
                app = initializeApp(config);
                db = getFirestore(app);
                auth = getAuth(app);
                
                logMessage('Firebase inicializado correctamente', 'success');
                
                // Crear colecciones
                await createCollections();
                
                // Crear usuario admin
                await createAdminUser();
                
                // Insertar datos de ejemplo
                await insertSampleData();
                
                // Marcar setup como completado
                await setDoc(doc(db, 'config', 'app'), {
                    setupCompleted: true,
                    createdAt: serverTimestamp(),
                    version: '1.0.0'
                });
                
                logMessage('Configuraci√≥n completada exitosamente!', 'success');
                showStatus('ready', '‚úÖ Sistema configurado correctamente. Redirigiendo...');
                
                // Redirigir a la app despu√©s de 3 segundos
                setTimeout(() => {
                    window.location.href = 'app.html';
                }, 3000);
                
            } catch (error) {
                logMessage(`Error: ${error.message}`, 'error');
                throw error;
            }
        }

        // Funci√≥n para crear colecciones
        async function createCollections() {
            const collections = [
                'config',
                'users',
                'insumos',
                'recetas',
                'producciones',
                'movimientos_stock'
            ];
            
            logMessage('Creando colecciones...', 'info');
            
            const batch = writeBatch(db);
            
            // Crear documentos vac√≠os para inicializar colecciones
            for (const collectionName of collections) {
                const docRef = doc(db, collectionName, '_init');
                batch.set(docRef, {
                    _createdAt: serverTimestamp(),
                    _type: 'init'
                });
            }
            
            await batch.commit();
            
            // Eliminar los documentos de inicializaci√≥n
            const deleteBatch = writeBatch(db);
            for (const collectionName of collections) {
                const docRef = doc(db, collectionName, '_init');
                deleteBatch.delete(docRef);
            }
            
            await deleteBatch.commit();
            
            logMessage(`${collections.length} colecciones creadas correctamente`, 'success');
        }

        // Funci√≥n para crear usuario admin
        async function createAdminUser() {
            logMessage('Creando usuario administrador...', 'info');
            
            try {
                // Crear usuario con email y contrase√±a
                const userCredential = await createUserWithEmailAndPassword(
                    auth, 
                    'admin@pasteleria.com', 
                    'Admin123'
                );
                
                // Guardar informaci√≥n adicional en Firestore
                await setDoc(doc(db, 'users', userCredential.user.uid), {
                    email: 'admin@pasteleria.com',
                    nombre: 'Administrador',
                    rol: 'admin',
                    createdAt: serverTimestamp(),
                    activo: true
                });
                
                logMessage('Usuario administrador creado: admin@pasteleria.com / Admin123', 'success');
                logMessage('IMPORTANTE: Cambie estas credenciales despu√©s del primer inicio de sesi√≥n', 'warning');
                
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') {
                    logMessage('Usuario admin ya existe', 'info');
                } else {
                    throw error;
                }
            }
        }

        // Funci√≥n para insertar datos de ejemplo
        async function insertSampleData() {
            logMessage('Insertando datos de ejemplo...', 'info');
            
            // Datos de ejemplo para insumos
            const insumosEjemplo = [
                {
                    id: 'insumo_harina',
                    nombre: 'Harina de Trigo',
                    unidad: 'kg',
                    stockActual: 5,
                    stockMinimo: 10,
                    costoUnitario: 1.20,
                    unidadCosto: 'kg',
                    categoria: 'Materia Prima',
                    proveedor: 'Proveedor A',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                },
                {
                    id: 'insumo_azucar',
                    nombre: 'Az√∫car Blanca',
                    unidad: 'kg',
                    stockActual: 3,
                    stockMinimo: 8,
                    costoUnitario: 0.90,
                    unidadCosto: 'kg',
                    categoria: 'Materia Prima',
                    proveedor: 'Proveedor B',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                },
                {
                    id: 'insumo_huevos',
                    nombre: 'Huevos',
                    unidad: 'u',
                    stockActual: 24,
                    stockMinimo: 48,
                    costoUnitario: 0.25,
                    unidadCosto: 'u',
                    categoria: 'Materia Prima',
                    proveedor: 'Proveedor C',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                },
                {
                    id: 'insumo_mantequilla',
                    nombre: 'Mantequilla',
                    unidad: 'g',
                    stockActual: 1000,
                    stockMinimo: 2000,
                    costoUnitario: 0.015,
                    unidadCosto: 'g',
                    categoria: 'Materia Prima',
                    proveedor: 'Proveedor A',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                }
            ];
            
            // Insertar insumos
            for (const insumo of insumosEjemplo) {
                await setDoc(doc(db, 'insumos', insumo.id), insumo);
            }
            
            logMessage(`${insumosEjemplo.length} insumos de ejemplo creados`, 'success');
            
            // Datos de ejemplo para recetas
            const recetasEjemplo = [
                {
                    id: 'receta_pastel_chocolate',
                    nombre: 'Pastel de Chocolate Cl√°sico',
                    descripcion: 'Pastel de chocolate esponjoso con cobertura de ganache',
                    porciones: 12,
                    dificultad: 'Media',
                    tiempoPreparacion: 90, // minutos
                    ingredientes: [
                        { insumoId: 'insumo_harina', nombre: 'Harina de Trigo', cantidad: 500, unidad: 'g' },
                        { insumoId: 'insumo_azucar', nombre: 'Az√∫car Blanca', cantidad: 300, unidad: 'g' },
                        { insumoId: 'insumo_huevos', nombre: 'Huevos', cantidad: 6, unidad: 'u' },
                        { insumoId: 'insumo_mantequilla', nombre: 'Mantequilla', cantidad: 200, unidad: 'g' }
                    ],
                    instrucciones: [
                        'Precalentar el horno a 180¬∞C',
                        'Mezclar los ingredientes secos',
                        'Batir los huevos con el az√∫car',
                        'Incorporar la mantequilla derretida',
                        'Hornear por 45 minutos'
                    ],
                    costoTotal: 0, // Se calcular√° din√°micamente
                    costoPorPorcion: 0, // Se calcular√° din√°micamente
                    activa: true,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                }
            ];
            
            // Insertar recetas
            for (const receta of recetasEjemplo) {
                await setDoc(doc(db, 'recetas', receta.id), receta);
            }
            
            logMessage(`${recetasEjemplo.length} recetas de ejemplo creadas`, 'success');
            logMessage('Datos de ejemplo insertados correctamente', 'success');
        }

        // Verificar estado del setup al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', async () => {
            const isSetupCompleted = await checkSetup();
            
            if (!isSetupCompleted) {
                setupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    // Obtener valores del formulario
                    const config = {
                        apiKey: document.getElementById('apiKey').value.trim(),
                        authDomain: document.getElementById('authDomain').value.trim(),
                        projectId: document.getElementById('projectId').value.trim(),
                        storageBucket: document.getElementById('storageBucket').value.trim(),
                        messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                        appId: document.getElementById('appId').value.trim()
                    };
                    
                    // Validar que todos los campos est√©n completos
                    if (Object.values(config).some(value => !value)) {
                        logMessage('Por favor complete todos los campos', 'error');
                        return;
                    }
                    
                    // Deshabilitar bot√≥n durante la configuraci√≥n
                    setupBtn.disabled = true;
                    setupBtn.textContent = 'Configurando...';
                    
                    try {
                        await initializeDatabase(config);
                    } catch (error) {
                        logMessage(`Error durante la configuraci√≥n: ${error.message}`, 'error');
                        setupBtn.disabled = false;
                        setupBtn.textContent = 'üëâ Inicializar Base de Datos';
                    }
                });
            }
        });

        // Agregar funcionalidad para copiar credenciales de ejemplo (solo para desarrollo)
        document.addEventListener('DOMContentLoaded', () => {
            // Solo para desarrollo - NO usar en producci√≥n
            const isLocalhost = window.location.hostname === 'localhost' || 
                               window.location.hostname === '127.0.0.1';
            
            if (isLocalhost) {
                const demoBtn = document.createElement('button');
                demoBtn.type = 'button';
                demoBtn.textContent = 'Usar credenciales de ejemplo (solo desarrollo)';
                demoBtn.style.cssText = `
                    margin-top: 10px;
                    background: #ff9800;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 8px;
                    cursor: pointer;
                    font-size: 14px;
                    width: 100%;
                `;
                demoBtn.onclick = () => {
                    document.getElementById('apiKey').value = 'AIzaSyCn-IxmpSh1PNg81zDCd8GUC7imM9XXAVA';
                    document.getElementById('authDomain').value = 'dolcefranrecetas.firebaseapp.com';
                    document.getElementById('projectId').value = 'dolcefranrecetas';
                    document.getElementById('storageBucket').value = 'dolcefranrecetas.firebasestorage.app';
                    document.getElementById('messagingSenderId').value = '322101534324';
                    document.getElementById('appId').value = '1:322101534324:web:e95dee5189edd3309ffb21';
                    
                    logMessage('Credenciales de ejemplo cargadas (solo para desarrollo)', 'warning');
                };
                
            }
        });
    </script>
</body>
</html>
