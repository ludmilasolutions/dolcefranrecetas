<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Pasteler√≠a Pro</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(90deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            opacity: 0.9;
            font-size: 16px;
        }
        
        .content {
            padding: 30px;
        }
        
        .setup-block {
            background-color: #f8f9fa;
            border-left: 5px solid #D2691E;
            padding: 20px;
            margin-bottom: 30px;
            border-radius: 0 8px 8px 0;
        }
        
        .setup-block h2 {
            color: #8B4513;
            margin-bottom: 15px;
            font-size: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            border-color: #D2691E;
            outline: none;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 16px;
            background: linear-gradient(90deg, #8B4513 0%, #D2691E 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-top: 20px;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(139, 69, 19, 0.3);
        }
        
        .btn:active {
            transform: translateY(0);
        }
        
        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .logs-container {
            background-color: #1a1a1a;
            color: #f0f0f0;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .log-item {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #333;
        }
        
        .log-success {
            color: #4CAF50;
        }
        
        .log-error {
            color: #f44336;
        }
        
        .log-info {
            color: #2196F3;
        }
        
        .alert {
            padding: 20px;
            background-color: #ff9800;
            color: white;
            border-radius: 8px;
            text-align: center;
            font-size: 18px;
            margin-bottom: 20px;
        }
        
        .steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            counter-reset: step;
        }
        
        .step {
            flex: 1;
            text-align: center;
            position: relative;
        }
        
        .step:before {
            counter-increment: step;
            content: counter(step);
            width: 40px;
            height: 40px;
            line-height: 40px;
            border-radius: 50%;
            background-color: #ddd;
            display: block;
            margin: 0 auto 10px;
            font-weight: bold;
            color: #666;
        }
        
        .step.active:before {
            background-color: #D2691E;
            color: white;
        }
        
        .step.completed:before {
            background-color: #4CAF50;
            color: white;
        }
        
        .step:not(:last-child):after {
            content: '';
            position: absolute;
            top: 20px;
            right: -50%;
            width: 100%;
            height: 2px;
            background-color: #ddd;
            z-index: -1;
        }
        
        .step.completed:after {
            background-color: #4CAF50;
        }
        
        .footer {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 14px;
            border-top: 1px solid #eee;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üç∞ Pasteler√≠a Pro - Configuraci√≥n</h1>
            <p>Configuraci√≥n inicial del sistema de gesti√≥n de pasteler√≠a</p>
        </div>
        
        <div class="content">
            <div class="steps">
                <div class="step active">1. Credenciales</div>
                <div class="step">2. Inicializar BD</div>
                <div class="step">3. Completado</div>
            </div>
            
            <div id="alreadyConfigured" class="alert hidden">
                ‚úÖ Sistema ya inicializado. Puedes cerrar esta p√°gina y acceder a la aplicaci√≥n principal.
            </div>
            
            <div id="setupForm">
                <div class="setup-block">
                    <h2>Configuraci√≥n de Firebase</h2>
                    <p>Ingresa las credenciales de tu proyecto Firebase. Puedes obtenerlas desde Firebase Console > Configuraci√≥n del proyecto > Tus aplicaciones.</p>
                    
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <input type="text" id="apiKey" placeholder="Ej: AIzaSyD...">
                    </div>
                    
                    <div class="form-group">
                        <label for="authDomain">Auth Domain</label>
                        <input type="text" id="authDomain" placeholder="Ej: mi-proyecto.firebaseapp.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="projectId">Project ID</label>
                        <input type="text" id="projectId" placeholder="Ej: mi-proyecto">
                    </div>
                    
                    <div class="form-group">
                        <label for="storageBucket">Storage Bucket</label>
                        <input type="text" id="storageBucket" placeholder="Ej: mi-proyecto.appspot.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="messagingSenderId">Messaging Sender ID</label>
                        <input type="text" id="messagingSenderId" placeholder="Ej: 123456789012">
                    </div>
                    
                    <div class="form-group">
                        <label for="appId">App ID</label>
                        <input type="text" id="appId" placeholder="Ej: 1:123456789012:web:abcd1234">
                    </div>
                    
                    <button id="initBtn" class="btn">üîß Inicializar Base de Datos</button>
                </div>
                
                <div class="logs-container">
                    <div id="logs">
                        <div class="log-item log-info">‚è≥ Esperando configuraci√≥n...</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Sistema de Gesti√≥n para Pasteler√≠a - Solo ejecutar esta configuraci√≥n una vez</p>
        </div>
    </div>

    <script>
        // Configuraci√≥n Firebase (se actualizar√° con los valores del formulario)
        const firebaseConfig = {
          apiKey: "AIzaSyCn-IxmpSh1PNg81zDCd8GUC7imM9XXAVA",
          authDomain: "dolcefranrecetas.firebaseapp.com",
          projectId: "dolcefranrecetas",
          storageBucket: "dolcefranrecetas.firebasestorage.app",
          messagingSenderId: "322101534324",
          appId: "1:322101534324:web:e95dee5189edd3309ffb21"
        };
        
        // Referencias globales
        let db;
        let auth;
        let setupCompleted = false;
        
        // Elementos DOM
        const alreadyConfiguredEl = document.getElementById('alreadyConfigured');
        const setupFormEl = document.getElementById('setupForm');
        const initBtn = document.getElementById('initBtn');
        const logsEl = document.getElementById('logs');
        const steps = document.querySelectorAll('.step');
        
        // Verificar si el sistema ya est√° configurado
        async function checkIfConfigured() {
            try {
                // Intentar cargar la configuraci√≥n de localStorage
                const savedConfig = localStorage.getItem('pasteleriaProConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // Intentar inicializar Firebase con la configuraci√≥n guardada
                    firebase.initializeApp(config.firebaseConfig);
                    db = firebase.firestore();
                    
                    // Verificar si ya existe la colecci√≥n de configuraci√≥n
                    const configDoc = await db.collection('systemConfig').doc('setup').get();
                    
                    if (configDoc.exists && configDoc.data().setupCompleted) {
                        setupCompleted = true;
                        alreadyConfiguredEl.classList.remove('hidden');
                        setupFormEl.classList.add('hidden');
                        
                        // Actualizar pasos
                        steps[0].classList.add('completed');
                        steps[1].classList.add('completed');
                        steps[2].classList.add('completed', 'active');
                    } else {
                        // Usar la configuraci√≥n guardada en el formulario
                        document.getElementById('apiKey').value = config.firebaseConfig.apiKey;
                        document.getElementById('authDomain').value = config.firebaseConfig.authDomain;
                        document.getElementById('projectId').value = config.firebaseConfig.projectId;
                        document.getElementById('storageBucket').value = config.firebaseConfig.storageBucket;
                        document.getElementById('messagingSenderId').value = config.firebaseConfig.messagingSenderId;
                        document.getElementById('appId').value = config.firebaseConfig.appId;
                        
                        addLog("‚úÖ Configuraci√≥n encontrada en localStorage", "success");
                    }
                }
            } catch (error) {
                addLog("‚ö†Ô∏è No se encontr√≥ configuraci√≥n previa. Proceder con nueva configuraci√≥n.", "info");
            }
        }
        
        // A√±adir mensaje a los logs
        function addLog(message, type = "info") {
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logsEl.appendChild(logItem);
            logsEl.scrollTop = logsEl.scrollHeight;
        }
        
        // Inicializar Firebase y base de datos
        async function initializeDatabase() {
            // Obtener valores del formulario
            firebaseConfig.apiKey = document.getElementById('apiKey').value.trim();
            firebaseConfig.authDomain = document.getElementById('authDomain').value.trim();
            firebaseConfig.projectId = document.getElementById('projectId').value.trim();
            firebaseConfig.storageBucket = document.getElementById('storageBucket').value.trim();
            firebaseConfig.messagingSenderId = document.getElementById('messagingSenderId').value.trim();
            firebaseConfig.appId = document.getElementById('appId').value.trim();
            
            // Validar que todos los campos est√©n completos
            for (const key in firebaseConfig) {
                if (!firebaseConfig[key]) {
                    addLog(`‚ùå Falta completar el campo: ${key}`, "error");
                    return;
                }
            }
            
            // Deshabilitar bot√≥n mientras se ejecuta
            initBtn.disabled = true;
            initBtn.textContent = "‚è≥ Inicializando...";
            
            try {
                addLog("üîó Conectando con Firebase...", "info");
                
                // Inicializar Firebase
                firebase.initializeApp(firebaseConfig);
                
                // Obtener referencias a Firestore y Authentication
                db = firebase.firestore();
                auth = firebase.auth();
                
                // Actualizar pasos
                steps[0].classList.add('completed');
                steps[1].classList.add('active');
                
                addLog("‚úÖ Firebase inicializado correctamente", "success");
                
                // Crear colecciones y documentos
                await createCollections();
                
                // Crear usuario admin inicial
                await createAdminUser();
                
                // Insertar datos de ejemplo
                await insertSampleData();
                
                // Marcar configuraci√≥n como completada
                await db.collection('systemConfig').doc('setup').set({
                    setupCompleted: true,
                    configuredAt: firebase.firestore.FieldValue.serverTimestamp(),
                    version: "1.0.0"
                });
                
                // Guardar configuraci√≥n en localStorage para uso futuro
                localStorage.setItem('pasteleriaProConfig', JSON.stringify({
                    firebaseConfig,
                    configuredAt: new Date().toISOString()
                }));
                
                // Actualizar pasos
                steps[1].classList.add('completed');
                steps[2].classList.add('completed', 'active');
                
                addLog("‚úÖ Configuraci√≥n completada exitosamente!", "success");
                addLog("üéâ Sistema listo para usar. Ahora puedes acceder a la aplicaci√≥n principal.", "info");
                
                // Mostrar credenciales de admin
                addLog("üìã Credenciales de administrador: admin@pasteleria.com / admin123", "info");
                addLog("‚ö†Ô∏è IMPORTANTE: Cambia estas credenciales despu√©s del primer inicio de sesi√≥n", "info");
                
                initBtn.textContent = "‚úÖ Configuraci√≥n Completada";
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, "error");
                initBtn.disabled = false;
                initBtn.textContent = "üîß Inicializar Base de Datos";
            }
        }
        
        // Crear las colecciones necesarias
        async function createCollections() {
            const collections = [
                'systemConfig',
                'users',
                'ingredients',
                'recipes',
                'productions',
                'stockMovements',
                'shoppingList'
            ];
            
            for (const collectionName of collections) {
                try {
                    // Crear un documento temporal para asegurar que la colecci√≥n existe
                    await db.collection(collectionName).doc('_temp').set({
                        created: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // Eliminar el documento temporal
                    await db.collection(collectionName).doc('_temp').delete();
                    
                    addLog(`‚úÖ Colecci√≥n '${collectionName}' creada`, "success");
                } catch (error) {
                    addLog(`‚ö†Ô∏è Colecci√≥n '${collectionName}': ${error.message}`, "info");
                }
            }
        }
        
        // Crear usuario administrador inicial
        async function createAdminUser() {
            try {
                // Crear usuario con email y contrase√±a
                const userCredential = await auth.createUserWithEmailAndPassword(
                    'admin@pasteleria.com',
                    'admin123'
                );
                
                // Guardar informaci√≥n adicional en Firestore
                await db.collection('users').doc(userCredential.user.uid).set({
                    email: 'admin@pasteleria.com',
                    name: 'Administrador',
                    role: 'admin',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                addLog("‚úÖ Usuario administrador creado: admin@pasteleria.com", "success");
            } catch (error) {
                // Si el usuario ya existe, solo actualizamos la informaci√≥n
                if (error.code === 'auth/email-already-in-use') {
                    addLog("‚ö†Ô∏è Usuario administrador ya existe", "info");
                } else {
                    addLog(`‚ùå Error creando usuario admin: ${error.message}`, "error");
                }
            }
        }
        
        // Insertar datos de ejemplo
        async function insertSampleData() {
            try {
                // 1. Insertar 2 insumos de ejemplo
                const ingredients = [
                    {
                        name: "Harina de Trigo",
                        unit: "kg",
                        currentStock: 10,
                        minStock: 5,
                        unitCost: 2.5,
                        costUnit: "kg",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    },
                    {
                        name: "Az√∫car Blanca",
                        unit: "kg",
                        currentStock: 3,  // Stock bajo para ejemplo
                        minStock: 5,
                        unitCost: 1.8,
                        costUnit: "kg",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    }
                ];
                
                for (const ingredient of ingredients) {
                    const docRef = await db.collection('ingredients').add(ingredient);
                    addLog(`‚úÖ Insumo creado: ${ingredient.name}`, "success");
                }
                
                // 2. Insertar 1 receta de ejemplo
                // Primero necesitamos obtener el ID de los insumos reci√©n creados
                const ingredientsSnapshot = await db.collection('ingredients').get();
                const ingredientIds = [];
                ingredientsSnapshot.forEach(doc => {
                    ingredientIds.push(doc.id);
                });
                
                if (ingredientIds.length >= 2) {
                    const recipe = {
                        name: "Pastel de Chocolate B√°sico",
                        description: "Pastel de chocolate esponjoso con cobertura",
                        portions: 8,
                        ingredients: [
                            {
                                ingredientId: ingredientIds[0],
                                name: "Harina de Trigo",
                                quantity: 0.5,
                                unit: "kg"
                            },
                            {
                                ingredientId: ingredientIds[1],
                                name: "Az√∫car Blanca",
                                quantity: 0.3,
                                unit: "kg"
                            }
                        ],
                        instructions: "1. Mezclar todos los ingredientes secos\n2. Agregar los huevos y la mantequilla\n3. Hornear a 180¬∞C por 40 minutos",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    await db.collection('recipes').add(recipe);
                    addLog("‚úÖ Receta creada: Pastel de Chocolate B√°sico", "success");
                }
                
                addLog("‚úÖ Datos de ejemplo insertados correctamente", "success");
            } catch (error) {
                addLog(`‚ö†Ô∏è Error insertando datos de ejemplo: ${error.message}`, "info");
            }
        }
        
        // Inicializar la verificaci√≥n al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', () => {
            checkIfConfigured();
            
            // Configurar el bot√≥n de inicializaci√≥n
            initBtn.addEventListener('click', initializeDatabase);
        });
    </script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</body>
</html>
