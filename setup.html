<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configuraci√≥n - Sistema Pasteler√≠a</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .setup-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            width: 100%;
            max-width: 800px;
            overflow: hidden;
        }

        .setup-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .setup-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .setup-header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .setup-content {
            padding: 40px;
        }

        .credentials-form {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
        }

        .form-group {
            display: grid;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #333;
            font-size: 0.9rem;
        }

        .form-group input {
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 18px 30px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .logs-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 30px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .log-entry {
            padding: 8px 12px;
            margin-bottom: 6px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            background: white;
        }

        .log-entry.success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }

        .log-entry.error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }

        .log-entry.warning {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }

        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .alert {
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .alert.warning {
            background: #fffbeb;
            border: 2px solid #f59e0b;
            color: #92400e;
        }

        .alert.success {
            background: #f0fdf4;
            border: 2px solid #10b981;
            color: #065f46;
        }

        .alert-icon {
            font-size: 2rem;
        }

        .setup-complete {
            text-align: center;
            padding: 40px;
        }

        .setup-complete h2 {
            color: #10b981;
            margin-bottom: 20px;
            font-size: 2rem;
        }

        .setup-complete p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }

        .emoji {
            font-size: 4rem;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .setup-container {
                margin: 10px;
            }
            
            .setup-content {
                padding: 20px;
            }
            
            .setup-header h1 {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <div class="setup-container">
        <div class="setup-header">
            <h1>üç∞ Configuraci√≥n del Sistema</h1>
            <p>Configuraci√≥n inicial de la aplicaci√≥n de gesti√≥n para pasteler√≠a</p>
        </div>
        
        <div class="setup-content">
            <div id="statusAlert" class="alert warning">
                <div class="alert-icon">‚ö†Ô∏è</div>
                <div>
                    <strong>Configuraci√≥n pendiente</strong>
                    <p>Por favor, ingresa las credenciales de Firebase y haz clic en "Inicializar Base de Datos"</p>
                </div>
            </div>
            
            <form id="setupForm" class="credentials-form">
                <div class="form-group">
                    <label for="apiKey">API Key</label>
                    <input type="text" id="apiKey" required placeholder="AIzaSyB...">
                </div>
                
                <div class="form-group">
                    <label for="authDomain">Auth Domain</label>
                    <input type="text" id="authDomain" required placeholder="tu-proyecto.firebaseapp.com">
                </div>
                
                <div class="form-group">
                    <label for="projectId">Project ID</label>
                    <input type="text" id="projectId" required placeholder="tu-proyecto">
                </div>
                
                <div class="form-group">
                    <label for="storageBucket">Storage Bucket</label>
                    <input type="text" id="storageBucket" required placeholder="tu-proyecto.appspot.com">
                </div>
                
                <div class="form-group">
                    <label for="messagingSenderId">Messaging Sender ID</label>
                    <input type="text" id="messagingSenderId" required placeholder="123456789012">
                </div>
                
                <div class="form-group">
                    <label for="appId">App ID</label>
                    <input type="text" id="appId" required placeholder="1:123456789012:web:abcd1234">
                </div>
                
                <button type="submit" class="btn" id="setupBtn">
                    <span>üë∑ Inicializar Base de Datos</span>
                </button>
            </form>
            
            <div class="progress-bar">
                <div class="progress" id="setupProgress"></div>
            </div>
            
            <div class="logs-container">
                <div id="logsContainer">
                    <div class="log-entry">üîç Esperando configuraci√≥n...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Firebase imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc,
            Timestamp,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { 
            getAuth, 
            createUserWithEmailAndPassword 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // DOM Elements
        const setupForm = document.getElementById('setupForm');
        const setupBtn = document.getElementById('setupBtn');
        const logsContainer = document.getElementById('logsContainer');
        const setupProgress = document.getElementById('setupProgress');
        const statusAlert = document.getElementById('statusAlert');

        // Check if setup is already completed
        async function checkSetupStatus() {
            try {
                // Try to load existing Firebase config from localStorage
                const savedConfig = localStorage.getItem('firebaseConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);
                    
                    // Pre-fill form with saved config
                    document.getElementById('apiKey').value = config.apiKey || '';
                    document.getElementById('authDomain').value = config.authDomain || '';
                    document.getElementById('projectId').value = config.projectId || '';
                    document.getElementById('storageBucket').value = config.storageBucket || '';
                    document.getElementById('messagingSenderId').value = config.messagingSenderId || '';
                    document.getElementById('appId').value = config.appId || '';
                    
                    // Try to connect and check setup status
                    const app = initializeApp(config);
                    const db = getFirestore(app);
                    
                    const configDoc = await getDoc(doc(db, 'config', 'app'));
                    
                    if (configDoc.exists() && configDoc.data().setupCompleted) {
                        showSetupComplete();
                        return true;
                    }
                }
            } catch (error) {
                console.log('No hay configuraci√≥n previa o error al verificar:', error.message);
            }
            return false;
        }

        // Show setup complete message
        function showSetupComplete() {
            statusAlert.className = 'alert success';
            statusAlert.innerHTML = `
                <div class="alert-icon">‚úÖ</div>
                <div>
                    <strong>Sistema ya inicializado</strong>
                    <p>El sistema ya ha sido configurado. Puedes proceder a usar la aplicaci√≥n principal.</p>
                </div>
            `;
            
            setupForm.style.display = 'none';
            setupProgress.parentElement.style.display = 'none';
            
            logsContainer.innerHTML = `
                <div class="log-entry success">‚úÖ Sistema ya configurado</div>
                <div class="log-entry">üì± Ve a app.html para usar la aplicaci√≥n</div>
                <div class="log-entry warning">‚ö†Ô∏è No ejecutes esta configuraci√≥n nuevamente</div>
            `;
            
            const completeDiv = document.createElement('div');
            completeDiv.className = 'setup-complete';
            completeDiv.innerHTML = `
                <div class="emoji">üéâ</div>
                <h2>Configuraci√≥n Completada</h2>
                <p>El sistema ha sido configurado exitosamente. Ahora puedes usar la aplicaci√≥n principal.</p>
                <a href="app.html" class="btn" style="width: 200px; margin: 0 auto;">
                    <span>üöÄ Ir a la Aplicaci√≥n</span>
                </a>
            `;
            
            document.querySelector('.setup-content').appendChild(completeDiv);
        }

        // Add log message
        function addLog(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            logEntry.textContent = `[${timestamp}] ${message}`;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // Update progress bar
        function updateProgress(percentage) {
            setupProgress.style.width = `${percentage}%`;
        }

        // Initialize database
        async function initializeDatabase(config) {
            try {
                setupBtn.disabled = true;
                setupBtn.innerHTML = '<span>‚è≥ Inicializando...</span>';
                
                addLog('üöÄ Iniciando configuraci√≥n del sistema...');
                updateProgress(10);
                
                // 1. Initialize Firebase
                addLog('‚öôÔ∏è Inicializando Firebase...');
                const app = initializeApp(config);
                const db = getFirestore(app);
                const auth = getAuth(app);
                
                updateProgress(20);
                addLog('‚úÖ Firebase inicializado correctamente');
                
                // 2. Create collections and documents
                addLog('üì¶ Creando estructura de datos...');
                
                // Check if config exists
                const configDocRef = doc(db, 'config', 'app');
                const configDoc = await getDoc(configDocRef);
                
                if (configDoc.exists()) {
                    throw new Error('El sistema ya ha sido configurado. No se puede ejecutar setup nuevamente.');
                }
                
                updateProgress(30);
                
                // Create config document
                await setDoc(configDocRef, {
                    setupCompleted: true,
                    createdAt: serverTimestamp(),
                    appName: 'Pasteler√≠a Management System',
                    version: '1.0.0'
                });
                addLog('‚úÖ Documento de configuraci√≥n creado');
                
                updateProgress(40);
                
                // Create admin user
                addLog('üë§ Creando usuario administrador...');
                try {
                    await createUserWithEmailAndPassword(
                        auth, 
                        'admin@pasteleria.com', 
                        'Admin123!'
                    );
                    addLog('‚úÖ Usuario administrador creado (admin@pasteleria.com / Admin123!)');
                } catch (authError) {
                    if (authError.code === 'auth/email-already-in-use') {
                        addLog('‚ö†Ô∏è Usuario administrador ya existe', 'warning');
                    } else {
                        throw authError;
                    }
                }
                
                updateProgress(50);
                
                // Create sample data
                addLog('üìù Insertando datos de ejemplo...');
                
                // Sample insumos
                const insumos = [
                    {
                        id: 'harina_00',
                        nombre: 'Harina 0000',
                        unidad: 'kg',
                        stockActual: 10,
                        stockMinimo: 5,
                        costoUnitario: 150,
                        unidadCosto: 'kg',
                        createdAt: serverTimestamp()
                    },
                    {
                        id: 'azucar',
                        nombre: 'Az√∫car refinada',
                        unidad: 'kg',
                        stockActual: 3,
                        stockMinimo: 8,
                        costoUnitario: 120,
                        unidadCosto: 'kg',
                        createdAt: serverTimestamp()
                    }
                ];
                
                for (const insumo of insumos) {
                    await setDoc(doc(db, 'insumos', insumo.id), insumo);
                }
                addLog(`‚úÖ ${insumos.length} insumos de ejemplo creados`);
                
                updateProgress(70);
                
                // Sample receta
                const recetaId = 'bizcochuelo_vainilla';
                await setDoc(doc(db, 'recetas', recetaId), {
                    nombre: 'Bizcochuelo de Vainilla',
                    descripcion: 'Bizcochuelo cl√°sico de vainilla para tortas',
                    porciones: 8,
                    ingredientes: [
                        {
                            insumoId: 'harina_00',
                            cantidad: 500,
                            unidad: 'g',
                            nombre: 'Harina 0000'
                        },
                        {
                            insumoId: 'azucar',
                            cantidad: 300,
                            unidad: 'g',
                            nombre: 'Az√∫car refinada'
                        }
                    ],
                    costoTotal: 105, // Calculado: (0.5 * 150) + (0.3 * 120)
                    costoPorPorcion: 13.125,
                    createdAt: serverTimestamp()
                });
                addLog('‚úÖ Receta de ejemplo creada');
                
                updateProgress(90);
                
                // Create other collections structure
                const collections = ['users', 'producciones', 'movimientos_stock'];
                for (const collectionName of collections) {
                    const dummyDoc = doc(collection(db, collectionName), 'dummy');
                    await setDoc(dummyDoc, { _placeholder: true });
                    await setDoc(dummyDoc, { _placeholder: false }); // Remove placeholder
                }
                addLog('‚úÖ Estructura de colecciones completada');
                
                updateProgress(100);
                
                // Save config to localStorage
                localStorage.setItem('firebaseConfig', JSON.stringify(config));
                
                addLog('üéâ Configuraci√≥n completada exitosamente!', 'success');
                addLog('üì± Redirigiendo a la aplicaci√≥n...');
                
                // Show success and redirect after 2 seconds
                setTimeout(() => {
                    window.location.href = 'app.html';
                }, 2000);
                
            } catch (error) {
                addLog(`‚ùå Error: ${error.message}`, 'error');
                setupBtn.disabled = false;
                setupBtn.innerHTML = '<span>üë∑ Reintentar Inicializaci√≥n</span>';
                throw error;
            }
        }

        // Form submit handler
        setupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const config = {
                apiKey: document.getElementById('apiKey').value.trim(),
                authDomain: document.getElementById('authDomain').value.trim(),
                projectId: document.getElementById('projectId').value.trim(),
                storageBucket: document.getElementById('storageBucket').value.trim(),
                messagingSenderId: document.getElementById('messagingSenderId').value.trim(),
                appId: document.getElementById('appId').value.trim()
            };
            
            // Validate config
            for (const [key, value] of Object.entries(config)) {
                if (!value) {
                    addLog(`‚ùå ${key} es requerido`, 'error');
                    return;
                }
            }
            
            try {
                await initializeDatabase(config);
            } catch (error) {
                // Error already logged in initializeDatabase
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', async () => {
            const isSetup = await checkSetupStatus();
            if (!isSetup) {
                addLog('‚úÖ Listo para configurar el sistema');
            }
        });
    </script>
</body>
</html>